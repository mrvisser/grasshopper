/**
 * Copyright (c) 2014 "Fronteer LTD"
 * Grasshopper Event Engine
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

var assert = require('assert');

var AppsTestsUtil = require('gh-apps/tests/util');
var ConfigTestsUtil = require('gh-config/tests/util');
var TenantsTestsUtil = require('gh-tenants/tests/util');
var TestsUtil = require('gh-tests');

var AuthTestsUtil = require('gh-auth/tests/util');

describe('Shibboleth authentication', function() {

    var tenant = null;
    var app = null;

    /*!
     * Create a test tenant and app before all tests
     */
    before(function(callback) {
        var displayName = TestsUtil.generateString();
        var host = TestsUtil.generateString().toLowerCase() + '.grasshopper.com';
        TestsUtil.getGlobalAdminRestClient(function(globalAdminClient) {
            TenantsTestsUtil.assertCreateTenant(globalAdminClient, displayName, function(_tenant) {
                AppsTestsUtil.assertCreateApp(globalAdminClient, _tenant.id, displayName, host, 'timetable', function(_app) {

                    tenant = _tenant;
                    app = _app;
                    return callback();
                });
            });
        });
    });

    /*!
     * Restore the shibboleth configuration before each test
     */
    beforeEach(function(callback) {
        TestsUtil.getGlobalAdminRestClient(function(globalAdminClient) {
            var defaultConfiguration = {
                'enableShibbolethAuth': true,
                'shibIdpEntityId': 'https://idp.olympia.edu/shibboleth',
                'shibExternalIdAttributes': 'eppn persistent-id targeted-id',
                'shibMapDisplayname': 'displayname cn',
                'shibMapEmail': 'mail email eppn',
                'shibMapLocale': 'locality locale'
            };
            ConfigTestsUtil.assertUpdateConfig(globalAdminClient, app.id, defaultConfiguration, callback);
        });
    });

    /**
     * Test that verifies that a user can log in through Shibboleth
     */
    it('verify a user can log in through Shibboleth', function(callback) {
        TestsUtil.getAnonymousAppUserClient(app, function(anonymousClient) {
            AuthTestsUtil.assertShibbolethApplicationRedirect(anonymousClient, '/event/foo', function(response) {
                console.log(response);
                console.log(response.jar);
                return callback();
            });
        });
    });
});
